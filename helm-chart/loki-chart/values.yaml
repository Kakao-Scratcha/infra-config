# Loki ì°¨íŠ¸ ê¸°ë³¸ ì„¤ì •

# Loki ì„¤ì • (ë‹¨ì¼ ëª¨ë“œ)
loki:
  enabled: true
  replicas: 1
  # ë‹¨ì¼ ë°”ì´ë„ˆë¦¬ ëª¨ë“œ í™œì„±í™”
  singleBinary:
    enabled: true
    # singleBinary ëª¨ë“œì˜ PVC ë¹„í™œì„±í™”
    persistence:
      enabled: false
  # ëª¨ë“  ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì»´í¬ë„ŒíŠ¸ ë¹„í™œì„±í™”
  backend:
    enabled: false
  write:
    enabled: false
  read:
    enabled: false
  gateway:
    enabled: false
  queryScheduler:
    enabled: false
  indexGateway:
    enabled: false
  compactor:
    enabled: false
  distributor:
    enabled: false
  ingester:
    enabled: false
  querier:
    enabled: false
  queryFrontend:
    enabled: false
  # PVC ë¹„í™œì„±í™” (S3 ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©)
  persistence:
    enabled: false
  
  # ğŸš€ Loki 6.x ë²„ì „ë¶€í„° config ì•„ë˜ë¡œ ì´ë™
  config:
    # ìŠ¤í‚¤ë§ˆ ì„¤ì •
    schemaConfig:
      configs:
        - from: 2020-10-24
          store: tsdb
          object_store: s3
          schema: v12
          index:
            prefix: index_
            period: 24h
    # ìŠ¤í† ë¦¬ì§€ ì„¤ì •
    storage_config:
      tsdb_shipper:
        active_index_directory: /tmp/loki/index # PVC ì•ˆ ì“°ë„ë¡ tmpfs ì§€ì •
        shared_store: s3
      aws:
        endpoint: ${LOKI_S3_ENDPOINT}
        bucketnames: ${LOKI_S3_BUCKET}
        access_key_id: ${LOKI_S3_ACCESS_KEY}
        secret_access_key: ${LOKI_S3_SECRET_KEY}
        s3forcepathstyle: true
        
  # í™˜ê²½ë³€ìˆ˜ ì„¤ì • (S3 Secret + í”„ë¡ì‹œ)
  extraEnv:
    # S3 ìŠ¤í† ë¦¬ì§€ ì„¤ì • (Kubernetes Secretì—ì„œ ë¡œë“œ)
    - name: LOKI_S3_ENDPOINT
      valueFrom:
        secretKeyRef:
          name: loki-s3-secret
          key: endpoint
    - name: LOKI_S3_BUCKET
      valueFrom:
        secretKeyRef:
          name: loki-s3-secret
          key: bucket
    - name: LOKI_S3_ACCESS_KEY
      valueFrom:
        secretKeyRef:
          name: loki-s3-secret
          key: access-key
    - name: LOKI_S3_SECRET_KEY
      valueFrom:
        secretKeyRef:
          name: loki-s3-secret
          key: secret-key
    # í”„ë¡ì‹œ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
    - name: HTTP_PROXY
      value: "http://10.0.130.50:3128"
    - name: HTTPS_PROXY
      value: "http://10.0.130.50:3128"
    - name: NO_PROXY
      value: "localhost,127.0.0.1,.svc.cluster.local,.cluster.local,10.96.0.0/12,10.244.0.0/16,10.0.0.0/8,kubernetes.default.svc.cluster.local"
    - name: http_proxy
      value: "http://10.0.130.50:3128"
    - name: https_proxy
      value: "http://10.0.130.50:3128"
    - name: no_proxy
      value: "localhost,127.0.0.1,.svc.cluster.local,.cluster.local,10.96.0.0/12,10.244.0.0/16,10.0.0.0/8,kubernetes.default.svc.cluster.local"
  resources:
    requests:
      memory: "512Mi"
      cpu: "250m"
    limits:
      memory: "1Gi"
      cpu: "500m"
  nodeSelector:
    kakaoi.io/kke-nodepool: team2-api
  service:
    type: ClusterIP
    port: 3100

# Promtail ì„¤ì • (Lokiì™€ í•¨ê»˜ ë¡œê·¸ ìˆ˜ì§‘)
promtail:
  enabled: true
  resources:
    requests:
      memory: "128Mi"
      cpu: "100m"
    limits:
      memory: "256Mi"
      cpu: "200m"
  nodeSelector:
    kakaoi.io/kke-nodepool: team2-api
  # Promtail í”„ë¡ì‹œ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
  extraEnv:
    - name: HTTP_PROXY
      value: "http://10.0.130.50:3128"
    - name: HTTPS_PROXY
      value: "http://10.0.130.50:3128"
    - name: NO_PROXY
      value: "localhost,127.0.0.1,.svc.cluster.local,.cluster.local,10.96.0.0/12,10.244.0.0/16,10.0.0.0/8,kubernetes.default.svc.cluster.local"
    - name: http_proxy
      value: "http://10.0.130.50:3128"
    - name: https_proxy
      value: "http://10.0.130.50:3128"
    - name: no_proxy
      value: "localhost,127.0.0.1,.svc.cluster.local,.cluster.local,10.96.0.0/12,10.244.0.0/16,10.0.0.0/8,kubernetes.default.svc.cluster.local"