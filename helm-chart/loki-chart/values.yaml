# Loki 차트 기본 설정

# Loki 설정
loki:
  enabled: true
  replicas: 1
  backend:
    replicas: 1
  write:
    replicas: 1
  # Loki S3 호환 오브젝트 스토리지 설정 (Kubernetes Secret 사용)
  storage:
    type: s3
  storage_config:
    aws:
      endpoint: ${LOKI_S3_ENDPOINT}
      bucketnames: ${LOKI_S3_BUCKET}
      access_key_id: ${LOKI_S3_ACCESS_KEY}
      secret_access_key: ${LOKI_S3_SECRET_KEY}
      s3forcepathstyle: true   # 대부분 S3 호환 스토리지에서 필요
  # 환경변수 설정 (S3 Secret + 프록시)
  extraEnv:
    # S3 스토리지 설정 (Kubernetes Secret에서 로드)
    - name: LOKI_S3_ENDPOINT
      valueFrom:
        secretKeyRef:
          name: loki-s3-secret
          key: endpoint
    - name: LOKI_S3_BUCKET
      valueFrom:
        secretKeyRef:
          name: loki-s3-secret
          key: bucket
    - name: LOKI_S3_ACCESS_KEY
      valueFrom:
        secretKeyRef:
          name: loki-s3-secret
          key: access-key
    - name: LOKI_S3_SECRET_KEY
      valueFrom:
        secretKeyRef:
          name: loki-s3-secret
          key: secret-key
    # 프록시 환경변수 설정
    - name: HTTP_PROXY
      value: "http://10.0.130.50:3128"
    - name: HTTPS_PROXY
      value: "http://10.0.130.50:3128"
    - name: NO_PROXY
      value: "localhost,127.0.0.1,.svc.cluster.local,.cluster.local"
    - name: http_proxy
      value: "http://10.0.130.50:3128"
    - name: https_proxy
      value: "http://10.0.130.50:3128"
    - name: no_proxy
      value: "localhost,127.0.0.1,.svc.cluster.local,.cluster.local"
  schemaConfig:
    configs:
      - from: 2020-10-24
        store: boltdb-shipper
        object_store: aws
        schema: v11
        index:
          prefix: index_
          period: 24h
  # PVC 설정 (인덱스용으로만 사용)
  persistence:
    enabled: true
    storageClassName: csi-cinder-sc-retain
    size: 1Gi  # 인덱스만 저장하므로 크기 축소
    accessModes:
      - ReadWriteOnce
  resources:
    requests:
      memory: "512Mi"
      cpu: "250m"
    limits:
      memory: "1Gi"
      cpu: "500m"
  nodeSelector:
    kakaoi.io/kke-nodepool: team2-api
  service:
    type: ClusterIP
    port: 3100

# Promtail 설정 (Loki와 함께 로그 수집)
promtail:
  enabled: true
  resources:
    requests:
      memory: "128Mi"
      cpu: "100m"
    limits:
      memory: "256Mi"
      cpu: "200m"
  nodeSelector:
    kakaoi.io/kke-nodepool: team2-api
  # Promtail 프록시 환경변수 설정
  extraEnv:
    - name: HTTP_PROXY
      value: "http://10.0.130.50:3128"
    - name: HTTPS_PROXY
      value: "http://10.0.130.50:3128"
    - name: NO_PROXY
      value: "localhost,127.0.0.1,.svc.cluster.local,.cluster.local"
    - name: http_proxy
      value: "http://10.0.130.50:3128"
    - name: https_proxy
      value: "http://10.0.130.50:3128"
    - name: no_proxy
      value: "localhost,127.0.0.1,.svc.cluster.local,.cluster.local"